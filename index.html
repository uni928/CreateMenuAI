<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>1é€±é–“ã®çŒ®ç«‹ææ¡ˆï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    textarea { width: 100%; height: 60px; margin-bottom: 10px; resize: vertical; font-family: monospace; }
    input[type="number"], select { font-size: 14px; margin-bottom: 10px; }
    label { display: block; margin-top: 10px; }
    .day-block { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 6px; }
    .preset-btn { margin-left: 5px; font-size: 14px; padding: 4px 8px; cursor: pointer; }
    button { margin-top: 10px; padding: 10px 20px; font-size: 16px; }
    #status { margin-top: 10px; color: green; }
    #error { color: red; margin-top: 10px; }
    #shoppingList { height: 180px; margin-top: 20px; }
  </style>
</head>
<body>

<h2>1é€±é–“ã®çŒ®ç«‹ææ¡ˆãƒ„ãƒ¼ãƒ«</h2>

<label>OpenAI APIã‚­ãƒ¼ï¼ˆChatGPTï¼‰:
  <input type="password" id="openaiKeyInput" style="width:300px;" placeholder="sk-..." />
</label><br>

<label>Gemini APIã‚­ãƒ¼ï¼ˆGoogle AIï¼‰:
  <input type="password" id="geminiKeyInput" style="width:300px;" placeholder="AIza..." />
</label><br>

<button id="setApiKeyBtn">APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã¿</button>
<div id="apiStatus" style="margin-top:10px; color: blue;"></div>


<label>1æ—¥åˆ†ã®äºˆç®—ï¼ˆå††ï¼‰:
  <input type="number" id="budgetInput" value="600" style="width: 80px;" />
  <button type="button" class="preset-btn" data-value="600">600</button>
  <button type="button" class="preset-btn" data-value="800">800</button>
  <button type="button" class="preset-btn" data-value="1000">1000</button>
  <button type="button" class="preset-btn" data-value="1200">1200</button>
</label>

<label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰:
  <input type="text" id="noteInput" placeholder="ä¾‹: æœã¯ãƒ‘ãƒ³ã®ã¿ã§" style="width: 300px;" />
</label>

<label>è²·ã„ç‰©å…ˆã®å¸Œæœ›:
  <select id="storeSelector">
    <option value="ã‚¹ãƒ¼ãƒ‘ãƒ¼">ã‚¹ãƒ¼ãƒ‘ãƒ¼</option>
    <option value="ã‚³ãƒ³ãƒ“ãƒ‹">ã‚³ãƒ³ãƒ“ãƒ‹</option>
  </select>
</label>

<div id="weekContainer"></div>

<button id="completeBtn">çŒ®ç«‹ã‚’ææ¡ˆã™ã‚‹</button>ã€€<button id="exportBtn">ğŸ“„ ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§å‡ºåŠ›</button>ã€€<button id="copyBtn">ğŸ“„ å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>

<br><button id="saveToFileBtn">ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜</button><input type="file" id="loadFromFileInput" style="display: none;" accept=".json">ã€€<button id="loadFromFileBtn">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>



<div id="status"></div>
<div id="error"></div>

<h3>ğŸ› ä»Šé€±ã®è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h3>
<textarea id="shoppingList" placeholder="é£Ÿæä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>

<script>
  let openaiKey = "";
  let geminiKey = "";
  let useGemini = false;

// èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã§ã‚­ãƒ¼è¨­å®š
document.getElementById("setApiKeyBtn").addEventListener("click", () => {
  openaiKey = document.getElementById("openaiKeyInput").value.trim();
  geminiKey = document.getElementById("geminiKeyInput").value.trim();
  useGemini = !!geminiKey;

  if (!openaiKey && !geminiKey) {
    document.getElementById("apiStatus").textContent = "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    document.getElementById("apiStatus").style.color = "red";
  } else {
    document.getElementById("apiStatus").textContent = useGemini
      ? "Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚"
      : "OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚";
    document.getElementById("apiStatus").style.color = "green";
  }
});


  const days = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];
  const weekContainer = document.getElementById("weekContainer");

  days.forEach(day => {
    const block = document.createElement("div");
    block.className = "day-block";
    block.innerHTML = `
      <h3>${day}æ›œæ—¥</h3>
      <label>æœé£Ÿ:</label>
      <textarea id="${day}_morning" placeholder="æœé£Ÿ"></textarea>
      <label>æ˜¼é£Ÿ:</label>
      <textarea id="${day}_lunch" placeholder="æ˜¼é£Ÿ"></textarea>
      <label>å¤•é£Ÿ:</label>
      <textarea id="${day}_dinner" placeholder="å¤•é£Ÿ"></textarea>
    `;
    weekContainer.appendChild(block);
  });

  document.querySelectorAll(".preset-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const value = btn.getAttribute("data-value");
      document.getElementById("budgetInput").value = value;
    });
  });

// çŒ®ç«‹ç”Ÿæˆãƒœã‚¿ãƒ³ã®ä¸­èº«ï¼ˆæ—¢å­˜å‡¦ç†ã®ä¸­èº«ã‚’æ›¸ãæ›ãˆï¼‰
document.getElementById("completeBtn").addEventListener("click", async () => {
  openaiKey = document.getElementById("openaiKeyInput").value.trim();
  geminiKey = document.getElementById("geminiKeyInput").value.trim();
  useGemini = !!geminiKey;

  if (!openaiKey && !geminiKey) {
    document.getElementById("apiStatus").textContent = "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    document.getElementById("apiStatus").style.color = "red";
  } else {
    document.getElementById("apiStatus").textContent = useGemini
      ? "Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚"
      : "OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚";
    document.getElementById("apiStatus").style.color = "green";
  }

  const budgetPerDay = parseInt(document.getElementById("budgetInput").value, 10) || 600;
  const store = document.getElementById("storeSelector").value;
  const totalBudget = budgetPerDay * 7;
  const button = document.getElementById("completeBtn");
  const status = document.getElementById("status");
  const error = document.getElementById("error");
  const shoppingList = document.getElementById("shoppingList");

  // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
  button.disabled = true;
  button.textContent = "è¨ˆç®—ä¸­...";
  status.textContent = "çŒ®ç«‹ã‚’ç”Ÿæˆä¸­ã§ã™â€¦";
  error.textContent = "";
  shoppingList.value = "";

  const prompt = `ä»¥ä¸‹ã®æ¡ä»¶ã§ã€1é€±é–“åˆ†ã®çŒ®ç«‹ï¼ˆæœãƒ»æ˜¼ãƒ»å¤œï¼‰ã¨è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š
- å„æ›œæ—¥ã«æœé£Ÿãƒ»æ˜¼é£Ÿãƒ»å¤•é£Ÿã‚’ææ¡ˆã—ã¦ãã ã•ã„
- 1æ—¥ã‚ãŸã‚Šã®äºˆç®—ã¯ ${budgetPerDay} å††ã€é€±åˆè¨ˆã§ ${totalBudget} å††ä»¥å†…ã«åã‚ã¦ãã ã•ã„
- è²·ã„ç‰©å…ˆã¯ ${store}
- é£Ÿæã¯ã§ãã‚‹ã ã‘ä½¿ã„å›ã—ã¦ç¯€ç´„ã‚’æ„è­˜ã—ã¦ãã ã•ã„
- å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼š

ã€çŒ®ç«‹ã€‘
æœˆæ›œæ—¥
æœé£Ÿ: ...
æ˜¼é£Ÿ: ...
å¤•é£Ÿ: ...
ï¼ˆä»¥ä¸‹ã€ç«ã€œæ—¥ï¼‰

ã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã€‘
- é£Ÿæå Ã— æ•°é‡`;

  try {
    const content = useGemini
      ? await completeWithGemini(prompt)
      : await completeWithChatGPT(prompt);

    days.forEach(day => {
      const regex = new RegExp(`${day}æ›œæ—¥[\\s\\S]*?æœé£Ÿ[:ï¼š\\n]([\\s\\S]*?)æ˜¼é£Ÿ[:ï¼š\\n]([\\s\\S]*?)å¤•é£Ÿ[:ï¼š\\n]([\\s\\S]*?)(?=\\n|\\r|\\n${day === "æ—¥" ? "ã€è²·ã„ç‰©" : days[days.indexOf(day)+1]+"æ›œ"})`, "i");
      const match = content.match(regex);
      document.getElementById(`${day}_morning`).value = match?.[1]?.trim() || "";
      document.getElementById(`${day}_lunch`).value = match?.[2]?.trim() || "";
      document.getElementById(`${day}_dinner`).value = match?.[3]?.trim() || "";
    });

    const shoppingMatch = content.match(/ã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã€‘([\s\S]*)/);
    shoppingList.value = shoppingMatch?.[1]?.trim() || "ï¼ˆè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰";

    status.textContent = "çŒ®ç«‹ã¨è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ææ¡ˆã—ã¾ã—ãŸã€‚";
  } catch (err) {
    console.error("APIã‚¨ãƒ©ãƒ¼è©³ç´°:", err);
    error.textContent = "ã‚¨ãƒ©ãƒ¼: " + (err.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
    status.textContent = "";
  } finally {
    button.disabled = false;
    button.textContent = "çŒ®ç«‹ã‚’ææ¡ˆã™ã‚‹";
  }
});



document.getElementById("exportBtn").addEventListener("click", () => {
    const days = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];
    let output = `ã€1é€±é–“ã®çŒ®ç«‹ã€‘\n`;

    days.forEach(day => {
      const morning = document.getElementById(`${day}_morning`).value.trim();
      const lunch   = document.getElementById(`${day}_lunch`).value.trim();
      const dinner  = document.getElementById(`${day}_dinner`).value.trim();
      output += `\nâ–  ${day}æ›œæ—¥\n`;
      output += `æœé£Ÿ: ${morning || "ï¼ˆæœªå…¥åŠ›ï¼‰"}\n`;
      output += `æ˜¼é£Ÿ: ${lunch || "ï¼ˆæœªå…¥åŠ›ï¼‰"}\n`;
      output += `å¤•é£Ÿ: ${dinner || "ï¼ˆæœªå…¥åŠ›ï¼‰"}\n`;
    });

    output += `\nã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã€‘\n`;
    const shopping = document.getElementById("shoppingList").value.trim();
    output += shopping || "ï¼ˆæœªå…¥åŠ›ï¼‰";

    // æ—¥ä»˜ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
    const today = new Date();
    const yyyymmdd = today.toISOString().slice(0,10).replace(/-/g, "");
    const fileName = `kondate_${yyyymmdd}.txt`;

    // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const blob = new Blob([output], { type: "text/plain;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
    URL.revokeObjectURL(link.href);
  });

document.getElementById("copyBtn").addEventListener("click", () => {
    const days = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];
    let output = `ã€1é€±é–“ã®çŒ®ç«‹ã€‘\n`;

    days.forEach(day => {
      const morning = document.getElementById(`${day}_morning`).value.trim();
      const lunch   = document.getElementById(`${day}_lunch`).value.trim();
      const dinner  = document.getElementById(`${day}_dinner`).value.trim();
      output += `\nâ–  ${day}æ›œæ—¥\n`;
      output += `æœé£Ÿ: ${morning || "ï¼ˆæœªå…¥åŠ›ï¼‰"}\n`;
      output += `æ˜¼é£Ÿ: ${lunch || "ï¼ˆæœªå…¥åŠ›ï¼‰"}\n`;
      output += `å¤•é£Ÿ: ${dinner || "ï¼ˆæœªå…¥åŠ›ï¼‰"}\n`;
    });

    output += `\nã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã€‘\n`;
    const shopping = document.getElementById("shoppingList").value.trim();
    output += shopping || "ï¼ˆæœªå…¥åŠ›ï¼‰";

    navigator.clipboard.writeText(output)
    .then(() => {
      alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    })
    .catch(err => {
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
    });
  });

// ChatGPTè£œå®Œéƒ¨åˆ†ã‚’é–¢æ•°åŒ–
async function completeWithChatGPT(prompt) {
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${openaiKey}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "ã‚ãªãŸã¯å„ªç§€ãªå®¶åº­ã®æ „é¤Šå£«ã§ã™ã€‚" },
        { role: "user", content: prompt }
      ],
      max_tokens: 2000,
      temperature: 0.7
    })
  });
  if (!res.ok) throw new Error("ChatGPT APIã‚¨ãƒ©ãƒ¼: " + res.status);
  const data = await res.json();
  return data.choices?.[0]?.message?.content || "";
}

// Geminiè£œå®Œ
async function completeWithGemini(prompt) {
  if (!geminiKey) throw new Error("Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");

  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`;

  const body = {
    contents: [{
      role: "user",
      parts: [{ text: prompt }]
    }],
    generationConfig: {
      temperature: 0.7,
      topP: 1.0,
      maxOutputTokens: 2048
    }
  };

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    const errorText = await res.text();
    throw new Error("Gemini APIã‚¨ãƒ©ãƒ¼: " + res.status + "\n" + errorText);
  }

  const data = await res.json();
  const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
  if (!result) throw new Error("Geminiã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æœ‰åŠ¹ãªçµæœãŒã‚ã‚Šã¾ã›ã‚“");
  return result;
}

// ğŸ”¹ ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
document.getElementById("saveToFileBtn").addEventListener("click", () => {
  const data = {
    openaiKey: document.getElementById("openaiKeyInput").value.trim(),
    geminiKey: document.getElementById("geminiKeyInput").value.trim(),
    note: document.getElementById("noteInput")?.value || "",
    budget: document.getElementById("budgetInput").value,
    store: document.getElementById("storeSelector").value,
    shopping: document.getElementById("shoppingList").value,
    days: {}
  };

  ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"].forEach(day => {
    data.days[day] = {
      morning: document.getElementById(`${day}_morning`).value,
      lunch: document.getElementById(`${day}_lunch`).value,
      dinner: document.getElementById(`${day}_dinner`).value
    };
  });

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  const now = new Date().toISOString().slice(0, 10);
  link.download = `kondate_data_${now}.json`;
  link.href = URL.createObjectURL(blob);
  link.click();
  URL.revokeObjectURL(link.href);
});

// ğŸ”¹ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒˆãƒªã‚¬ãƒ¼
document.getElementById("loadFromFileBtn").addEventListener("click", () => {
  document.getElementById("loadFromFileInput").click();
});

// ğŸ”¹ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œã®èª­ã¿è¾¼ã¿å‡¦ç†
document.getElementById("loadFromFileInput").addEventListener("change", e => {
  const file = e.target.files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);

      document.getElementById("openaiKeyInput").value = data.openaiKey || "";
      document.getElementById("geminiKeyInput").value = data.geminiKey || "";
      document.getElementById("noteInput").value = data.note || "";
      document.getElementById("budgetInput").value = data.budget || 600;
      document.getElementById("storeSelector").value = data.store || "ã‚¹ãƒ¼ãƒ‘ãƒ¼";
      document.getElementById("shoppingList").value = data.shopping || "";

      if (data.days) {
        Object.entries(data.days).forEach(([day, meals]) => {
          document.getElementById(`${day}_morning`).value = meals.morning || "";
          document.getElementById(`${day}_lunch`).value = meals.lunch || "";
          document.getElementById(`${day}_dinner`).value = meals.dinner || "";
        });
      }

openaiKey = document.getElementById("openaiKeyInput").value.trim();
  geminiKey = document.getElementById("geminiKeyInput").value.trim();
  useGemini = !!geminiKey;

  if (!openaiKey && !geminiKey) {
    document.getElementById("apiStatus").textContent = "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    document.getElementById("apiStatus").style.color = "red";
  } else {
    document.getElementById("apiStatus").textContent = useGemini
      ? "Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚"
      : "OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚";
    document.getElementById("apiStatus").style.color = "green";
  }

      alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
    } catch (err) {
      alert("èª­ã¿è¾¼ã¿å¤±æ•—ï¼š" + err.message);
    }
  };
  reader.readAsText(file);
});


</script>


</body>
</html>
